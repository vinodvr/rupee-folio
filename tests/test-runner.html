<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculator Tests - GlidePath Planner</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #10B981;
      padding-bottom: 10px;
    }
    .summary {
      display: flex;
      gap: 20px;
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .summary-item {
      text-align: center;
      padding: 10px 20px;
    }
    .summary-item.passed {
      border-left: 4px solid #10B981;
    }
    .summary-item.failed {
      border-left: 4px solid #EF4444;
    }
    .summary-item.total {
      border-left: 4px solid #3B82F6;
    }
    .summary-number {
      font-size: 2em;
      font-weight: bold;
    }
    .summary-label {
      color: #666;
      font-size: 0.9em;
    }
    .test-group {
      background: white;
      border-radius: 8px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .test-group-header {
      background: #f8f9fa;
      padding: 12px 16px;
      font-weight: bold;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .test-group-header:hover {
      background: #f0f0f0;
    }
    .test-result {
      display: flex;
      align-items: center;
      padding: 10px 16px;
      border-bottom: 1px solid #f0f0f0;
    }
    .test-result:last-child {
      border-bottom: none;
    }
    .test-status {
      width: 60px;
      font-weight: bold;
      font-size: 0.85em;
    }
    .test-status.pass {
      color: #10B981;
    }
    .test-status.fail {
      color: #EF4444;
    }
    .test-name {
      flex: 1;
    }
    .test-error {
      color: #EF4444;
      font-size: 0.85em;
      margin-left: 60px;
      padding: 8px;
      background: #FEF2F2;
      border-radius: 4px;
      margin-top: 5px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .run-button {
      background: #10B981;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 1em;
      cursor: pointer;
      margin-bottom: 20px;
    }
    .run-button:hover {
      background: #059669;
    }
    .run-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Unit Tests - GlidePath Planner</h1>

  <div style="margin-bottom: 20px;">
    <button id="runTests" class="run-button">Run All Tests</button>
    <span id="testSuites" style="margin-left: 15px; color: #666;">
      Suites: Calculator, Currency, Storage
    </span>
  </div>

  <div id="summary" class="summary" style="display: none;">
    <div class="summary-item total">
      <div class="summary-number" id="totalCount">0</div>
      <div class="summary-label">Total</div>
    </div>
    <div class="summary-item passed">
      <div class="summary-number" id="passedCount">0</div>
      <div class="summary-label">Passed</div>
    </div>
    <div class="summary-item failed">
      <div class="summary-number" id="failedCount">0</div>
      <div class="summary-label">Failed</div>
    </div>
  </div>

  <div id="results"></div>

  <script type="module">
    const runButton = document.getElementById('runTests');
    const summaryDiv = document.getElementById('summary');
    const resultsDiv = document.getElementById('results');

    // Test suites to run
    const testSuites = [
      { name: 'Calculator', file: './calculator.test.js' },
      { name: 'Currency', file: './currency.test.js' },
      { name: 'Storage', file: './storage.test.js' }
    ];

    runButton.addEventListener('click', async () => {
      runButton.disabled = true;
      runButton.textContent = 'Running...';
      resultsDiv.innerHTML = '<div class="loading">Running tests...</div>';

      let totalPassed = 0;
      let totalFailed = 0;
      const allResults = [];

      try {
        const timestamp = Date.now();

        // Run all test suites
        for (const suite of testSuites) {
          try {
            const module = await import(`${suite.file}?t=${timestamp}`);
            const { results, passed, failed } = module;

            totalPassed += passed;
            totalFailed += failed;

            // Prefix results with suite name
            results.forEach(result => {
              allResults.push({
                ...result,
                name: `[${suite.name}] ${result.name}`,
                suite: suite.name
              });
            });
          } catch (suiteError) {
            totalFailed++;
            allResults.push({
              name: `[${suite.name}] Failed to load test suite`,
              status: 'FAIL',
              error: suiteError.message,
              suite: suite.name
            });
          }
        }

        // Show summary
        summaryDiv.style.display = 'flex';
        document.getElementById('totalCount').textContent = totalPassed + totalFailed;
        document.getElementById('passedCount').textContent = totalPassed;
        document.getElementById('failedCount').textContent = totalFailed;

        // Group results by suite, then by category
        const suiteGroups = {};
        allResults.forEach(result => {
          if (!suiteGroups[result.suite]) suiteGroups[result.suite] = {};

          // Extract category from name (after suite prefix)
          const nameWithoutSuite = result.name.replace(`[${result.suite}] `, '');
          const match = nameWithoutSuite.match(/^([^:]+):/);
          const category = match ? match[1] : 'Other';

          if (!suiteGroups[result.suite][category]) {
            suiteGroups[result.suite][category] = [];
          }
          suiteGroups[result.suite][category].push({
            ...result,
            displayName: nameWithoutSuite
          });
        });

        // Render results
        let html = '';
        for (const [suiteName, categories] of Object.entries(suiteGroups)) {
          const suiteResults = Object.values(categories).flat();
          const suitePassed = suiteResults.filter(t => t.status === 'PASS').length;
          const suiteTotal = suiteResults.length;

          html += `<h2 style="margin-top: 30px; color: #333;">${suiteName} Tests (${suitePassed}/${suiteTotal})</h2>`;

          for (const [category, tests] of Object.entries(categories)) {
            const catPassed = tests.filter(t => t.status === 'PASS').length;
            const catTotal = tests.length;

            html += `
              <div class="test-group">
                <div class="test-group-header">
                  ${category} (${catPassed}/${catTotal})
                </div>
                <div class="test-group-body">
            `;

            for (const test of tests) {
              html += `
                <div class="test-result">
                  <span class="test-status ${test.status.toLowerCase()}">${test.status}</span>
                  <span class="test-name">${test.displayName}</span>
                </div>
              `;
              if (test.error) {
                html += `<div class="test-error">${test.error}</div>`;
              }
            }

            html += `</div></div>`;
          }
        }

        resultsDiv.innerHTML = html;

      } catch (error) {
        resultsDiv.innerHTML = `
          <div class="test-group">
            <div class="test-result">
              <span class="test-status fail">ERROR</span>
              <span class="test-name">Failed to run tests</span>
            </div>
            <div class="test-error">${error.message}</div>
          </div>
        `;
        console.error(error);
      }

      runButton.disabled = false;
      runButton.textContent = 'Run All Tests Again';
    });
  </script>
</body>
</html>
